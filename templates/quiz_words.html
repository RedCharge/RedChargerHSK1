<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSK1 Words Quiz - Master Chinese Vocabulary</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Georgia', 'serif'],
                    },
                    colors: {
                        'primary-blue': '#5c7cfa',
                        'secondary-cyan': '#33f0e8',
                        'main-bg': '#1e293b',
                        'card-bg': '#2a3a50',
                        'text-light': '#e2e8f0',
                        'text-muted': '#94a3b8',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        gradientShift: {
                            '0%': { backgroundPosition: '0% 50%' },
                            '100%': { backgroundPosition: '100% 50%' },
                        },
                        pulseCorrect: {
                            '0%': { boxShadow: '0 0 0 0 rgba(34, 197, 94, 0.7)' },
                            '70%': { boxShadow: '0 0 0 10px rgba(34, 197, 94, 0)' },
                            '100%': { boxShadow: '0 0 0 0 rgba(34, 197, 94, 0)' },
                        },
                        pulseIncorrect: {
                            '0%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0.7)' },
                            '70%': { boxShadow: '0 0 0 10px rgba(239, 68, 68, 0)' },
                            '100%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0)' },
                        },
                        fadeInDown: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    },
                    animation: {
                        fadeInUp: 'fadeInUp 0.6s ease-out forwards',
                        gradientShift: 'gradientShift 3s ease infinite alternate',
                        pulseCorrect: 'pulseCorrect 1s ease',
                        pulseIncorrect: 'pulseIncorrect 1s ease',
                        fadeInDown: 'fadeInDown 0.3s ease-out forwards',
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e293b;
            min-height: 100vh;
            color: #e2e8f0;
            overflow-x: hidden;
            position: relative;
        }

        .nav-card {
            background-color: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sophisticated-card {
            background-color: #2a3a50;
            border-radius: 0.75rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .sophisticated-card:hover {
             transform: translateY(-5px) scale(1.01);
             box-shadow: 0 12px 35px rgba(0, 0, 0, 0.6), 0 0 20px rgba(92, 124, 250, 0.3);
        }

        .cta-button-primary, .cta-button-secondary {
            border: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cta-button-primary {
            background: linear-gradient(135deg, #5c7cfa, #3d5ad8);
            color: white;
            box-shadow: 0 5px 20px rgba(92, 124, 250, 0.5);
            background-size: 200% auto;
            animation: gradientShift 3s ease infinite alternate;
        }
        
        .cta-button-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(92, 124, 250, 0.7);
        }

        .cta-button-secondary {
            background: linear-gradient(135deg, #33f0e8, #25c0b8);
            color: #1e293b;
            box-shadow: 0 5px 20px rgba(51, 240, 232, 0.4);
        }

        .cta-button-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(51, 240, 232, 0.6);
        }

        .animate-on-scroll {
            opacity: 0;
            transition-property: opacity, transform;
            transition-duration: 0.7s;
            transition-timing-function: cubic-bezier(0.23, 1, 0.32, 1);
            transform: translateY(20px);
        }

        .animate-on-scroll.animate-fadeInUp {
            opacity: 1;
            transform: translateY(0);
        }
        
        .option-button {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .option-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .option-button.correct {
            border-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
            animation: pulseCorrect 1s ease;
        }
        
        .option-button.incorrect {
            border-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
            animation: pulseIncorrect 1s ease;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #334155;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #5c7cfa, #33f0e8);
            transition: width 0.5s ease;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5c7cfa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile dropdown menu styles - Full Width */
        .mobile-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: rgba(42, 58, 80, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 50;
            opacity: 0;
            transform: translateY(-10px);
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .mobile-dropdown-menu.open {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .mobile-dropdown-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 45;
            background-color: transparent;
            display: none;
        }

        /* Speech button styles */
        .speech-button {
            transition: all 0.3s ease;
        }
        
        .speech-button:hover {
            transform: scale(1.1);
        }
        
        .speech-button.playing {
            color: #33f0e8;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="selection:bg-primary-blue selection:text-white">

    <!-- Navigation Bar with Full-Width Dropdown Menu -->
    <nav class="fixed top-0 left-0 right-0 z-50 p-4 lg:p-6 nav-card">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="text-2xl font-black tracking-widest bg-clip-text text-transparent bg-gradient-to-r from-text-light to-secondary-cyan">
                RedCharger
            </div>
            
            <!-- Desktop Menu -->
            <div class="space-x-8 hidden md:flex font-medium">
                <a href="/" class="text-text-muted hover:text-secondary-cyan transition duration-300">Home</a>
                <a href="/words/quiz" class="text-secondary-cyan transition duration-300">Words Quiz</a>
                <a href="/sentences/quiz" class="text-text-muted hover:text-secondary-cyan transition duration-300">Sentences Quiz</a>
                <a href="/learn" class="text-text-muted hover:text-secondary-cyan transition duration-300">Learn</a>
                <a href="/chat" class="text-text-muted hover:text-secondary-cyan transition duration-300">Community Chat</a>
                
            </div>

            <!-- Desktop View Results Button -->
            <a href="/result" class="hidden md:flex py-2 px-5 rounded-full cta-button-secondary font-extrabold text-base shadow-xl hover:shadow-2xl transition duration-300">
                View Results
            </a>

            <!-- Mobile Menu Container -->
            <div class="md:hidden flex items-center space-x-3">
                <!-- Mobile View Results Button -->
                <a href="/result" class="py-1 px-3 rounded-full text-sm cta-button-secondary font-bold shadow-xl transition duration-300">
                    Results
                </a>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-button" class="text-text-muted hover:text-secondary-cyan transition duration-300 relative z-50">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Dropdown Menu - Full Width -->
        <div id="mobile-dropdown-menu" class="mobile-dropdown-menu md:hidden w-full left-0">
            <div class="p-4 space-y-3">
                <a href="/" class="flex items-center text-text-light hover:text-secondary-cyan transition duration-300 p-3 rounded-lg hover:bg-card-bg/50">
                    <i class="fas fa-home mr-3 w-5 text-center"></i>
                    <span>Home</span>
                </a>
                <a href="/words/quiz" class="flex items-center text-secondary-cyan transition duration-300 p-3 rounded-lg hover:bg-card-bg/50">
                    <i class="fas fa-book mr-3 w-5 text-center"></i>
                    <span>Words Quiz</span>
                </a>
                <a href="/sentences/quiz" class="flex items-center text-text-light hover:text-secondary-cyan transition duration-300 p-3 rounded-lg hover:bg-card-bg/50">
                    <i class="fas fa-comments mr-3 w-5 text-center"></i>
                    <span>Sentences Quiz</span>
                </a>
                <a href="/learn" class="flex items-center text-text-light hover:text-secondary-cyan transition duration-300 p-3 rounded-lg hover:bg-card-bg/50">
                    <i class="fas fa-graduation-cap mr-3 w-5 text-center"></i>
                    <span>Learn</span>
                </a>
    
                <a href="/chat" class="flex items-center text-text-light hover:text-secondary-cyan transition duration-300 p-3 rounded-lg hover:bg-card-bg/50">
                    <i class="fas fa-users mr-3 w-5 text-center"></i>
                    <span>Community Chat</span>
                </a>
                
            </div>
        </div>
    </nav>

    <!-- Mobile Dropdown Backdrop -->
    <div id="mobile-dropdown-backdrop" class="mobile-dropdown-backdrop md:hidden"></div>

    <main class="pt-24 pb-16">
        <!-- Quiz Header -->
        <section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mb-12">
            <div class="text-center">
                <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-text-light">
                    HSK1 <span class="text-secondary-cyan">Words Quiz</span>
                </h1>
                <p class="text-xl text-text-muted max-w-2xl mx-auto">
                    Test your knowledge of essential HSK1 vocabulary. Answer all questions to see your results!
                </p>
                <div class="mt-4 flex items-center justify-center space-x-4">
                    <button id="speech-toggle" class="py-2 px-4 rounded-lg bg-card-bg text-text-light border border-text-muted/30 font-medium hover:bg-text-muted/10 transition duration-300">
                        <i class="fas fa-volume-up mr-2"></i> Enable Speech
                    </button>
                    <div id="speech-status" class="text-sm text-text-muted">
                        Click the speaker icon to hear words
                    </div>
                </div>
            </div>
        </section>

        <!-- Quiz Container -->
        <section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="sophisticated-card p-6 md:p-8">
                <!-- Loading State -->
                <div id="loading-state" class="text-center py-12">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-text-muted">Loading quiz questions...</p>
                </div>

                <!-- Quiz Content (Initially Hidden) -->
                <div id="quiz-content" class="hidden">
                    <!-- Progress Bar -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-text-light font-medium">Progress</span>
                            <span id="progress-text" class="text-text-muted">0/20</span>
                        </div>
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Score Display -->
                    <div class="flex justify-between items-center mb-8">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-text-light" id="score">0</div>
                            <div class="text-text-muted text-sm">Score</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-text-light" id="correct-count">0</div>
                            <div class="text-text-muted text-sm">Correct</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-text-light" id="incorrect-count">0</div>
                            <div class="text-text-muted text-sm">Incorrect</div>
                        </div>
                    </div>

                    <!-- Question Container -->
                    <div id="question-container" class="mb-8">
                        <!-- Question content will be dynamically inserted here -->
                    </div>

                    <!-- Options Container -->
                    <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <!-- Options will be dynamically inserted here -->
                    </div>

                    <!-- Feedback Message -->
                    <div id="feedback" class="mb-6 text-center text-lg font-medium hidden"></div>

                    <!-- Navigation Buttons -->
                    <div class="flex justify-between">
                        <button id="prev-btn" class="py-3 px-6 rounded-lg bg-card-bg text-text-light border border-text-muted/30 font-medium hover:bg-text-muted/10 transition duration-300 opacity-50 cursor-not-allowed" disabled>
                            <i class="fas fa-arrow-left mr-2"></i> Previous
                        </button>
                        <button id="next-btn" class="py-3 px-6 rounded-lg cta-button-primary font-medium">
                            Next <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Error State -->
                <div id="error-state" class="hidden text-center py-12">
                    <i class="fas fa-exclamation-triangle text-red-400 text-5xl mb-4"></i>
                    <h3 class="text-2xl font-bold text-text-light mb-2">Failed to Load Quiz</h3>
                    <p class="text-text-muted mb-6" id="error-message">There was an error loading the quiz questions.</p>
                    <button id="retry-btn" class="py-3 px-6 rounded-lg cta-button-primary font-medium">
                        <i class="fas fa-redo mr-2"></i> Try Again
                    </button>
                </div>

                <!-- Results Section (Initially Hidden) -->
                <div id="results-section" class="hidden mt-12 text-center">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold mb-4 text-text-light">Quiz Complete!</h2>
                        <div class="text-5xl font-extrabold mb-2" id="final-score">0</div>
                        <div class="text-text-muted text-lg">Your Final Score</div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-card-bg/50 p-4 rounded-lg">
                            <div class="text-3xl font-bold text-green-400" id="final-correct">0</div>
                            <div class="text-text-muted">Correct Answers</div>
                        </div>
                        <div class="bg-card-bg/50 p-4 rounded-lg">
                            <div class="text-3xl font-bold text-red-400" id="final-incorrect">0</div>
                            <div class="text-text-muted">Incorrect Answers</div>
                        </div>
                        <div class="bg-card-bg/50 p-4 rounded-lg">
                            <div class="text-3xl font-bold text-secondary-cyan" id="final-percentage">0%</div>
                            <div class="text-text-muted">Accuracy</div>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4 text-text-light">Performance Summary</h3>
                        <p id="performance-message" class="text-text-muted text-lg max-w-2xl mx-auto">
                            <!-- Performance message will be inserted here -->
                        </p>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="restart-btn" class="py-3 px-6 rounded-lg cta-button-primary font-medium">
                            <i class="fas fa-redo mr-2"></i> Take Quiz Again
                        </button>
                        <a href="/result" class="py-3 px-6 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition duration-300 inline-flex items-center justify-center">
                            <i class="fas fa-chart-line mr-2"></i> View Detailed Results
                        </a>
                        <button id="home-btn" class="py-3 px-6 rounded-lg bg-card-bg text-text-light border border-text-muted/30 font-medium hover:bg-text-muted/10 transition duration-300">
                            <i class="fas fa-home mr-2"></i> Back to Home
                        </button>
                    </div>
                </div>

                <!-- Start Screen -->
                <div id="start-screen" class="text-center py-8">
                    <h2 class="text-2xl font-bold mb-4 text-text-light">Ready to test your knowledge?</h2>
                    <p class="text-text-muted mb-6">This quiz will test you on 20 randomly selected words from the HSK1 vocabulary list.</p>
                    <div class="mb-6 p-4 bg-card-bg/50 rounded-lg">
                        <h3 class="text-lg font-bold mb-2 text-text-light">New Feature: Text-to-Speech</h3>
                        <p class="text-text-muted text-sm">Click the speaker icon next to each word to hear its pronunciation!</p>
                    </div>
                    <button id="start-btn" class="py-3 px-6 rounded-lg cta-button-primary font-medium">
                        <i class="fas fa-play mr-2"></i> Start Quiz
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="py-10 border-t border-main-bg/20 text-center text-text-muted bg-card-bg">
        <p class="text-sm">&copy; 2025 RedCharger. Designed for effective Mandarin learning.</p>
    </footer>

    <!-- Quiz Logic -->
     <script>
            // Quiz state
let currentQuestion = 0;
let score = 0;
let correctAnswers = 0;
let incorrectAnswers = 0;
let userAnswers = [];
let quizData = [];
let quizStarted = false;
let startTime = null;
let speechEnabled = true;
let speechSynthesis = window.speechSynthesis;
let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
let userInteractedWithSpeech = false;
let audioContext = null;
let preloadedAudio = {};
let autoSpeakEnabled = true;

// Adaptive Learning State
let wordMastery = {}; // Track mastery for each word
let currentWordQueue = []; // Queue of words to be presented
let masteredWords = new Set(); // Words the user has mastered
let reviewWords = []; // Words that need review
let questionTypes = ['multiple-choice', 'typing', 'audio-recognition']; // Different question formats

// DOM elements
const loadingState = document.getElementById('loading-state');
const startScreen = document.getElementById('start-screen');
const quizContent = document.getElementById('quiz-content');
const errorState = document.getElementById('error-state');
const questionContainer = document.getElementById('question-container');
const optionsContainer = document.getElementById('options-container');
const feedbackElement = document.getElementById('feedback');
const nextButton = document.getElementById('next-btn');
const prevButton = document.getElementById('prev-btn');
const progressText = document.getElementById('progress-text');
const progressFill = document.getElementById('progress-fill');
const scoreElement = document.getElementById('score');
const correctCountElement = document.getElementById('correct-count');
const incorrectCountElement = document.getElementById('incorrect-count');
const resultsSection = document.getElementById('results-section');
const finalScoreElement = document.getElementById('final-score');
const finalCorrectElement = document.getElementById('final-correct');
const finalIncorrectElement = document.getElementById('final-incorrect');
const finalPercentageElement = document.getElementById('final-percentage');
const performanceMessageElement = document.getElementById('performance-message');
const restartButton = document.getElementById('restart-btn');
const homeButton = document.getElementById('home-btn');
const retryButton = document.getElementById('retry-btn');
const errorMessage = document.getElementById('error-message');
const startButton = document.getElementById('start-btn');
const speechToggle = document.getElementById('speech-toggle');
const speechStatus = document.getElementById('speech-status');

// Mobile Menu Elements
const mobileMenuButton = document.getElementById('mobile-menu-button');
const mobileDropdownMenu = document.getElementById('mobile-dropdown-menu');
const mobileDropdownBackdrop = document.getElementById('mobile-dropdown-backdrop');

// Mobile Menu State
let isMenuOpen = false;

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    // Show start screen first
    loadingState.classList.add('hidden');
    quizContent.classList.add('hidden');
    errorState.classList.add('hidden');
    resultsSection.classList.add('hidden');
    startScreen.classList.remove('hidden');
    
    // Set up event listeners
    startButton.addEventListener('click', startQuiz);
    retryButton.addEventListener('click', startQuiz);
    restartButton.addEventListener('click', startQuiz);
    homeButton.addEventListener('click', () => {
        window.location.href = '/';
    });
    
    // Speech toggle
    speechToggle.addEventListener('click', toggleSpeech);
    
    // Initialize speech system
    initializeSpeechSystem();
    
    // Initialize audio context for sound effects
    initializeAudioContext();
    
    // Test speech capabilities
    testSpeechCapabilities();
    
    // Add user interaction listeners for mobile auto-speak
    setupUserInteractionListeners();
    
    // Initialize mobile menu
    initializeMobileMenu();
    
    // Initialize adaptive learning
    initializeAdaptiveLearning();
    
    // Add reset button (optional)
    addResetButton();
});

// ============================
// ADAPTIVE LEARNING ALGORITHM
// ============================

// Initialize adaptive learning system
function initializeAdaptiveLearning() {
    console.log('Initializing adaptive learning system...');
    
    // Load mastery data from localStorage if available
    const savedMastery = localStorage.getItem('wordMastery');
    if (savedMastery) {
        wordMastery = JSON.parse(savedMastery);
        console.log('Loaded mastery data for', Object.keys(wordMastery).length, 'words');
    }
    
    // Load mastered words
    const savedMasteredWords = localStorage.getItem('masteredWords');
    if (savedMasteredWords) {
        masteredWords = new Set(JSON.parse(savedMasteredWords));
        console.log('Loaded', masteredWords.size, 'mastered words');
    }
    
    // Load review words
    const savedReviewWords = localStorage.getItem('reviewWords');
    if (savedReviewWords) {
        reviewWords = JSON.parse(savedReviewWords);
        console.log('Loaded', reviewWords.length, 'words for review');
    }
}

// Save adaptive learning data
function saveAdaptiveLearningData() {
    localStorage.setItem('wordMastery', JSON.stringify(wordMastery));
    localStorage.setItem('masteredWords', JSON.stringify([...masteredWords]));
    localStorage.setItem('reviewWords', JSON.stringify(reviewWords));
    console.log('Adaptive learning data saved');
}

// Process words with adaptive learning logic
function processWordsWithAdaptiveLearning(words) {
    // Reset current word queue
    currentWordQueue = [];
    
    // Separate words into categories based on mastery
    const newWords = [];
    const weakWords = [];
    const strongWords = [];
    
    words.forEach(word => {
        const wordKey = word.word; // Use the word itself as the key
        
        // If word is already mastered, skip it (or include occasionally for reinforcement)
        if (masteredWords.has(wordKey) && Math.random() > 0.1) { // 10% chance to include mastered words
            return;
        }
        
        // Check if we have mastery data for this word
        if (wordMastery[wordKey]) {
            const mastery = wordMastery[wordKey];
            
            // Calculate mastery score (0-100)
            const totalAttempts = mastery.correct + mastery.incorrect;
            const masteryScore = totalAttempts > 0 ? (mastery.correct / totalAttempts) * 100 : 0;
            
            // Categorize based on mastery score
            if (masteryScore < 60) {
                weakWords.push(word);
            } else if (masteryScore < 85) {
                strongWords.push(word);
            } else {
                // Consider mastered if consistently high performance
                if (mastery.correct >= 3 && masteryScore >= 85) {
                    masteredWords.add(wordKey);
                } else {
                    strongWords.push(word);
                }
            }
        } else {
            // New word - no previous data
            newWords.push(word);
        }
    });
    
    console.log('Word categorization:', {
        newWords: newWords.length,
        weakWords: weakWords.length,
        strongWords: strongWords.length
    });
    
    // Build word queue with adaptive distribution
    // Priority: Weak words > New words > Strong words
    const targetCount = Math.min(20, words.length);
    
    // Add weak words (highest priority - 50% of quiz)
    const weakCount = Math.min(Math.ceil(targetCount * 0.5), weakWords.length);
    currentWordQueue.push(...weakWords.slice(0, weakCount));
    
    // Add new words (medium priority - 30% of quiz)
    const newCount = Math.min(Math.ceil(targetCount * 0.3), newWords.length);
    currentWordQueue.push(...newWords.slice(0, newCount));
    
    // Add strong words (lowest priority - 20% of quiz)
    const strongCount = Math.min(targetCount - currentWordQueue.length, strongWords.length);
    currentWordQueue.push(...strongWords.slice(0, strongCount));
    
    // If we still need more words, add from review list
    if (currentWordQueue.length < targetCount && reviewWords.length > 0) {
        const needed = targetCount - currentWordQueue.length;
        const reviewToAdd = reviewWords.slice(0, Math.min(needed, reviewWords.length));
        currentWordQueue.push(...reviewToAdd);
        
        // Remove added words from review list
        reviewWords = reviewWords.slice(reviewToAdd.length);
    }
    
    // Shuffle the queue to mix word difficulties
    shuffleArray(currentWordQueue);
    
    console.log('Final word queue:', currentWordQueue.length, 'words');
    return currentWordQueue;
}

// Update word mastery after each question
function updateWordMastery(word, isCorrect) {
    const wordKey = word.word;
    
    // Initialize word mastery if it doesn't exist
    if (!wordMastery[wordKey]) {
        wordMastery[wordKey] = {
            correct: 0,
            incorrect: 0,
            lastSeen: new Date().toISOString(),
            questionTypes: {},
            streak: 0
        };
    }
    
    const mastery = wordMastery[wordKey];
    
    // Update counts
    if (isCorrect) {
        mastery.correct++;
        mastery.streak = Math.max(0, mastery.streak + 1); // Increment positive streak
    } else {
        mastery.incorrect++;
        mastery.streak = Math.min(0, mastery.streak - 1); // Decrement streak (goes negative)
    }
    
    mastery.lastSeen = new Date().toISOString();
    
    // Track question type usage
    const questionType = 'multiple-choice'; // Default, can be expanded
    if (!mastery.questionTypes[questionType]) {
        mastery.questionTypes[questionType] = { correct: 0, incorrect: 0 };
    }
    
    if (isCorrect) {
        mastery.questionTypes[questionType].correct++;
    } else {
        mastery.questionTypes[questionType].incorrect++;
    }
    
    // Check if word should be added to review list
    if (!isCorrect && !reviewWords.some(w => w.word === wordKey)) {
        reviewWords.push(word);
        console.log('Added to review words:', wordKey);
    }
    
    // Check for mastery (3 consecutive correct answers)
    if (mastery.streak >= 3) {
        masteredWords.add(wordKey);
        console.log('Word mastered:', wordKey);
        
        // Remove from review list if it was there
        reviewWords = reviewWords.filter(w => w.word !== wordKey);
    }
    
    // Save updated data
    saveAdaptiveLearningData();
    
    console.log('Updated mastery for', wordKey, ':', mastery);
}

// Calculate adaptive learning statistics
function calculateAdaptiveLearningStats() {
    const stats = {
        masteredThisSession: 0,
        weakWordsCount: 0,
        reviewWordsCount: reviewWords.length,
        totalMastered: masteredWords.size,
        masteryProgress: 0
    };
    
    // Count words mastered in this session
    quizData.forEach(question => {
        const wordKey = question.word;
        if (masteredWords.has(wordKey) && wordMastery[wordKey]) {
            const mastery = wordMastery[wordKey];
            // Check if mastered recently (in this session)
            const lastSeen = new Date(mastery.lastSeen);
            const sessionStart = new Date(startTime);
            if (lastSeen > sessionStart && mastery.streak >= 3) {
                stats.masteredThisSession++;
            }
        }
    });
    
    // Count weak words (less than 60% accuracy)
    Object.keys(wordMastery).forEach(wordKey => {
        const mastery = wordMastery[wordKey];
        const totalAttempts = mastery.correct + mastery.incorrect;
        if (totalAttempts > 0) {
            const accuracy = (mastery.correct / totalAttempts) * 100;
            if (accuracy < 60) {
                stats.weakWordsCount++;
            }
        }
    });
    
    // Calculate overall mastery progress
    const totalTrackedWords = Object.keys(wordMastery).length;
    if (totalTrackedWords > 0) {
        stats.masteryProgress = Math.round((masteredWords.size / totalTrackedWords) * 100);
    }
    
    return stats;
}

// Utility function to shuffle array
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// Reset adaptive learning data (for testing or user reset)
function resetAdaptiveLearningData() {
    if (confirm('Are you sure you want to reset your learning progress? This will clear all your mastery data.')) {
        wordMastery = {};
        masteredWords = new Set();
        reviewWords = [];
        localStorage.removeItem('wordMastery');
        localStorage.removeItem('masteredWords');
        localStorage.removeItem('reviewWords');
        console.log('Adaptive learning data reset');
        alert('Learning progress has been reset. Starting fresh!');
    }
}

// Add reset button to your UI (optional)
function addResetButton() {
    const resetButton = document.createElement('button');
    resetButton.id = 'reset-progress-btn';
    resetButton.className = 'py-2 px-4 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition duration-300 mt-4';
    resetButton.innerHTML = '<i class="fas fa-redo mr-2"></i> Reset Progress';
    resetButton.addEventListener('click', resetAdaptiveLearningData);
    
    // Add to start screen or settings area
    const startScreen = document.getElementById('start-screen');
    if (startScreen) {
        startScreen.appendChild(resetButton);
    }
}

// ============================
// EXISTING QUIZ FUNCTIONALITY
// ============================

// Initialize Audio Context for sound effects
function initializeAudioContext() {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        console.log('AudioContext initialized for sound effects');
    } catch (e) {
        console.log('AudioContext not supported for sound effects');
    }
}

// Play correct answer sound
function playCorrectSound() {
    if (!audioContext) {
        console.log('AudioContext not available for sound effects');
        return;
    }

    try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Happy, ascending sound
        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
        oscillator.frequency.exponentialRampToValueAtTime(1046.50, audioContext.currentTime + 0.3); // C6
        
        oscillator.type = 'sine';
        
        // Smooth volume envelope
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
        
        console.log('Played correct answer sound');
    } catch (e) {
        console.log('Correct sound failed:', e);
    }
}

// Play incorrect answer sound
function playIncorrectSound() {
    if (!audioContext) {
        console.log('AudioContext not available for sound effects');
        return;
    }

    try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Sad, descending sound
        oscillator.frequency.setValueAtTime(392.00, audioContext.currentTime); // G4
        oscillator.frequency.exponentialRampToValueAtTime(261.63, audioContext.currentTime + 0.4); // C4
        
        oscillator.type = 'sawtooth';
        
        // Quick attack, slower release
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.05);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.6);
        
        console.log('Played incorrect answer sound');
    } catch (e) {
        console.log('Incorrect sound failed:', e);
    }
}

// Play level up sound for excellent scores
function playLevelUpSound() {
    if (!audioContext) return;

    try {
        const times = [0, 0.1, 0.2, 0.3, 0.4];
        const frequencies = [523.25, 659.25, 783.99, 1046.50, 1318.51]; // C5, E5, G5, C6, E6
        
        times.forEach((time, index) => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequencies[index], audioContext.currentTime + time);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime + time);
            gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + time + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.3);
            
            oscillator.start(audioContext.currentTime + time);
            oscillator.stop(audioContext.currentTime + time + 0.3);
        });
        
        console.log('Played level up sound');
    } catch (e) {
        console.log('Level up sound failed:', e);
    }
}

// Initialize Mobile Menu
function initializeMobileMenu() {
    // Toggle mobile menu
    function toggleMobileMenu() {
        isMenuOpen = !isMenuOpen;
        
        if (isMenuOpen) {
            // Open menu
            mobileDropdownMenu.classList.add('open');
            mobileDropdownBackdrop.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent scrolling
            
            // Change icon to X
            mobileMenuButton.innerHTML = '<i class="fas fa-times text-xl"></i>';
            mobileMenuButton.classList.remove('text-text-muted');
            mobileMenuButton.classList.add('text-secondary-cyan');
        } else {
            // Close menu
            mobileDropdownMenu.classList.remove('open');
            mobileDropdownBackdrop.style.display = 'none';
            document.body.style.overflow = ''; // Re-enable scrolling
            
            // Change icon back to hamburger
            mobileMenuButton.innerHTML = '<i class="fas fa-bars text-xl"></i>';
            mobileMenuButton.classList.remove('text-secondary-cyan');
            mobileMenuButton.classList.add('text-text-muted');
        }
    }

    // Close mobile menu
    function closeMobileMenu() {
        isMenuOpen = false;
        mobileDropdownMenu.classList.remove('open');
        mobileDropdownBackdrop.style.display = 'none';
        document.body.style.overflow = ''; // Re-enable scrolling
        
        // Reset icon
        mobileMenuButton.innerHTML = '<i class="fas fa-bars text-xl"></i>';
        mobileMenuButton.classList.remove('text-secondary-cyan');
        mobileMenuButton.classList.add('text-text-muted');
    }

    // Event Listeners
    mobileMenuButton.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleMobileMenu();
    });

    // Close menu when clicking on backdrop
    mobileDropdownBackdrop.addEventListener('click', closeMobileMenu);

    // Close menu when clicking on menu links
    const menuLinks = mobileDropdownMenu.querySelectorAll('a');
    menuLinks.forEach(link => {
        link.addEventListener('click', closeMobileMenu);
    });

    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
        if (isMenuOpen && 
            !mobileDropdownMenu.contains(e.target) && 
            !mobileMenuButton.contains(e.target)) {
            closeMobileMenu();
        }
    });

    // Close menu on escape key
    document.addEventListener('keydown', function(e) {
        if (isMenuOpen && e.key === 'Escape') {
            closeMobileMenu();
        }
    });

    // Close menu on window resize (if resizing to desktop)
    window.addEventListener('resize', function() {
        if (window.innerWidth >= 768 && isMenuOpen) {
            closeMobileMenu();
        }
    });
}

// Setup user interaction listeners for mobile
function setupUserInteractionListeners() {
    // Listen for any user interaction to enable auto-speak
    document.addEventListener('click', function() {
        userInteractedWithSpeech = true;
        console.log('User interaction detected - auto-speak enabled');
    }, { once: true });
    
    // Also listen for touch events on mobile
    if (isMobile) {
        document.addEventListener('touchstart', function() {
            userInteractedWithSpeech = true;
            console.log('Touch interaction detected - auto-speak enabled');
        }, { once: true });
    }
}

// Initialize speech system
function initializeSpeechSystem() {
    if (!speechSynthesis) {
        speechToggle.disabled = true;
        speechToggle.innerHTML = '<i class="fas fa-volume-mute mr-2"></i> Speech Not Supported';
        speechStatus.textContent = 'Your browser does not support text-to-speech';
        speechEnabled = false;
        autoSpeakEnabled = false;
        return;
    }
    
    // Check for mobile-specific speech issues
    if (isMobile) {
        speechStatus.textContent = 'Auto-speak enabled after first interaction';
        console.log('Mobile device detected - auto-speak will work after user interaction');
        
        // Try to initialize AudioContext for fallback sounds
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            console.log('AudioContext initialized for fallback sounds');
        } catch (e) {
            console.log('AudioContext not supported for fallback sounds');
        }
    } else {
        speechStatus.textContent = 'Auto-speak enabled - words will be read automatically';
    }
    
    // Load voices when available
    speechSynthesis.onvoiceschanged = function() {
        const voices = speechSynthesis.getVoices();
        console.log('Available voices:', voices.length);
        const chineseVoices = voices.filter(voice => 
            voice.lang.includes('zh') || voice.lang.includes('cn') || voice.lang.includes('zh-CN')
        );
        console.log('Chinese voices available:', chineseVoices.length);
        
        if (chineseVoices.length === 0) {
            speechStatus.textContent += '. No Chinese voice found - using default voice.';
        }
    };
    
    // Force voices to load
    setTimeout(() => {
        const voices = speechSynthesis.getVoices();
        console.log('Voices loaded:', voices.length);
    }, 1000);
}

// Test speech capabilities
function testSpeechCapabilities() {
    if (!speechSynthesis) return;
    
    // Test with a simple English word to see if TTS works at all
    setTimeout(() => {
        const testUtterance = new SpeechSynthesisUtterance('test');
        testUtterance.volume = 0.1; // Very quiet
        testUtterance.onend = function() {
            console.log('Basic TTS test passed');
        };
        testUtterance.onerror = function(e) {
            console.log('Basic TTS test failed:', e.error);
        };
        speechSynthesis.speak(testUtterance);
        setTimeout(() => speechSynthesis.cancel(), 100);
    }, 2000);
}

// Toggle speech functionality
function toggleSpeech() {
    speechEnabled = !speechEnabled;
    autoSpeakEnabled = speechEnabled; // Auto-speak follows speech toggle
    
    if (speechEnabled) {
        speechToggle.innerHTML = '<i class="fas fa-volume-up mr-2"></i> Disable Speech';
        updateSpeechStatus();
        speechToggle.classList.remove('bg-red-500', 'text-white');
        speechToggle.classList.add('bg-card-bg', 'text-text-light');
    } else {
        speechToggle.innerHTML = '<i class="fas fa-volume-mute mr-2"></i> Enable Speech';
        speechStatus.textContent = 'Speech is disabled';
        speechToggle.classList.remove('bg-card-bg', 'text-text-light');
        speechToggle.classList.add('bg-red-500', 'text-white');
        
        // Stop any ongoing speech
        speechSynthesis.cancel();
    }
}

// Update speech status message
function updateSpeechStatus() {
    if (isMobile) {
        speechStatus.textContent = 'Auto-speak enabled after first interaction';
    } else {
        speechStatus.textContent = 'Auto-speak enabled - words will be read automatically';
    }
}

// Auto-speak function for new questions
function autoSpeakQuestion(word) {
    if (!speechEnabled || !autoSpeakEnabled) {
        console.log('Auto-speak disabled');
        return;
    }
    
    // On mobile, only auto-speak after user has interacted
    if (isMobile && !userInteractedWithSpeech) {
        console.log('Waiting for user interaction before auto-speaking on mobile');
        return;
    }
    
    console.log('Auto-speaking word:', word);
    speakText(word);
}

// Speak text using Web Speech API with multiple fallbacks
function speakText(text, language = 'zh-CN') {
    if (!speechEnabled) {
        console.log('Speech is disabled');
        return;
    }
    
    // Stop any ongoing speech
    speechSynthesis.cancel();
    
    // Update button to show loading state
    const speechButton = document.getElementById('speech-button');
    if (speechButton) {
        speechButton.disabled = true;
        speechButton.classList.add('opacity-50', 'cursor-not-allowed', 'bg-secondary-cyan/20', 'text-secondary-cyan', 'border-secondary-cyan');
        speechButton.classList.remove('cursor-pointer', 'hover:bg-card-bg/70', 'bg-card-bg', 'text-text-light', 'border-text-muted/30');
        speechButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        speechButton.title = 'Loading...';
    }
    
    // Try multiple speech methods
    attemptSpeech(text, language, 0);
}

// Attempt speech with fallbacks
function attemptSpeech(text, language, attempt) {
    const speechButton = document.getElementById('speech-button');
    
    if (attempt === 0) {
        // Method 1: Try with Chinese voice
        console.log('Attempt 1: Trying Chinese TTS');
        speakWithVoice(text, language, true);
    } else if (attempt === 1) {
        // Method 2: Try with any available voice
        console.log('Attempt 2: Trying any available voice');
        speakWithVoice(text, 'en-US', false);
    } else if (attempt === 2) {
        // Method 3: Try fallback beep sound
        console.log('Attempt 3: Using fallback sound');
        playFallbackSound();
        resetSpeechButton();
    } else {
        // All methods failed
        console.log('All speech methods failed');
        speechStatus.textContent = 'Speech not available';
        resetSpeechButton();
    }
}

// Speak with specific voice preference
function speakWithVoice(text, language, preferChinese = true) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = language;
    utterance.rate = isMobile ? 0.7 : 0.8;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    // Get available voices
    const voices = speechSynthesis.getVoices();
    let selectedVoice = null;
    
    if (preferChinese) {
        // Try to find Chinese voice
        selectedVoice = voices.find(voice => 
            voice.lang.includes('zh') || voice.lang.includes('cn') || voice.lang.includes('zh-CN')
        );
    }
    
    // If no Chinese voice found or not preferring Chinese, use default
    if (!selectedVoice) {
        selectedVoice = voices.find(voice => voice.default) || voices[0];
    }
    
    if (selectedVoice) {
        utterance.voice = selectedVoice;
        console.log('Using voice:', selectedVoice.name, selectedVoice.lang);
    }
    
    // Set up event handlers
    utterance.onstart = function() {
        console.log('Speech started successfully');
        const speechButton = document.getElementById('speech-button');
        if (speechButton) {
            speechButton.innerHTML = '<i class="fas fa-volume-up animate-pulse"></i>';
            speechButton.title = 'Speaking...';
        }
    };
    
    utterance.onend = function() {
        console.log('Speech completed successfully');
        resetSpeechButton();
    };
    
    utterance.onerror = function(event) {
        console.error('Speech error:', event.error);
        // Try next method
        setTimeout(() => attemptSpeech(text, language, attempt + 1), 100);
    };
    
    // Speak with timeout
    speechSynthesis.speak(utterance);
    
    // Set timeout in case speech never starts
    setTimeout(() => {
        if (speechSynthesis.speaking) {
            console.log('Speech is speaking, seems successful');
        } else {
            console.log('Speech never started, trying next method');
                speechSynthesis.cancel();
                setTimeout(() => attemptSpeech(text, language, attempt + 1), 100);
            }
        }, 1000);
    }

    // Play fallback sound
    function playFallbackSound() {
        if (!audioContext) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Cannot create AudioContext for fallback sound');
                return;
            }
        }
        
        try {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 440; // A4 note
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
            
            console.log('Played fallback sound');
        } catch (e) {
            console.log('Fallback sound failed:', e);
        }
    }

    // Reset speech button to normal state
    function resetSpeechButton() {
        const speechButton = document.getElementById('speech-button');
        if (speechButton) {
            speechButton.classList.remove('playing', 'opacity-50', 'cursor-not-allowed', 'bg-secondary-cyan/20', 'text-secondary-cyan', 'border-secondary-cyan');
            speechButton.classList.add('cursor-pointer', 'hover:bg-card-bg/70', 'bg-card-bg', 'text-text-light', 'border-text-muted/30');
            speechButton.innerHTML = '<i class="fas fa-volume-up"></i>';
            speechButton.disabled = false;
            speechButton.title = 'Click to hear pronunciation';
            speechButton.setAttribute('aria-label', 'Click to hear pronunciation');
        }
    }

    // Start the quiz
    function startQuiz() {
        startScreen.classList.add('hidden');
        resultsSection.classList.add('hidden');
        errorState.classList.add('hidden');
        loadingState.classList.remove('hidden');
        
        // Reset speech interaction flag for new quiz
        userInteractedWithSpeech = false;
        
        loadQuizData();
    }

    // Enhanced loadQuizData function with adaptive learning
    async function loadQuizData() {
        try {
            console.log('Loading quiz data with adaptive learning...');
            
            const response = await fetch('/words/api/quiz-words?count=20');
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('API Response:', data);
            
            if (data.success && data.words && Array.isArray(data.words)) {
                // Process words with adaptive learning logic
                quizData = processWordsWithAdaptiveLearning(data.words);
                console.log(`Successfully loaded ${quizData.length} questions with adaptive learning`);
                
                // Log adaptive learning info
                console.log('Adaptive Learning Stats:', {
                    totalWords: data.words.length,
                    masteredWords: masteredWords.size,
                    reviewWords: reviewWords.length,
                    wordQueueLength: currentWordQueue.length
                });
                
                initQuiz();
            } else {
                throw new Error(data.message || 'Invalid data structure received from API');
            }
            
        } catch (error) {
            console.error('Quiz loading error:', error);
            showError(`Failed to load quiz: ${error.message}. Please check if the server is running.`);
        }
    }

    // Initialize the quiz
    function initQuiz() {
        if (!quizData || quizData.length === 0) {
            showError('No quiz questions available. Please try again.');
            return;
        }
        
        currentQuestion = 0;
        score = 0;
        correctAnswers = 0;
        incorrectAnswers = 0;
        userAnswers = new Array(quizData.length).fill(null);
        startTime = new Date();
        
        loadingState.classList.add('hidden');
        quizContent.classList.remove('hidden');
        
        showQuestion();
        updateProgress();
        updateScore();
        
        nextButton.addEventListener('click', nextQuestion);
        prevButton.addEventListener('click', prevQuestion);
        
        // Setup interaction listeners for this quiz session
        setupQuizInteractionListeners();
    }

    // Setup interaction listeners specifically for the quiz
    function setupQuizInteractionListeners() {
        // Remove any existing listeners and add new ones
        document.removeEventListener('click', handleQuizInteraction);
        document.removeEventListener('touchstart', handleQuizInteraction);
        
        document.addEventListener('click', handleQuizInteraction);
        if (isMobile) {
            document.addEventListener('touchstart', handleQuizInteraction);
        }
    }

    function handleQuizInteraction() {
        if (!userInteractedWithSpeech) {
            userInteractedWithSpeech = true;
            console.log('Quiz interaction detected - auto-speak now enabled');
            
            // Auto-speak the current question if this is the first interaction
            if (speechEnabled && autoSpeakEnabled) {
                const currentWord = quizData[currentQuestion]?.word;
                if (currentWord) {
                    setTimeout(() => {
                        console.log('Auto-speaking after first interaction:', currentWord);
                        speakText(currentWord);
                    }, 300);
                }
            }
        }
    }

    // Show current question
    function showQuestion() {
        const question = quizData[currentQuestion];
        
        if (!question || !question.word || !question.options || !Array.isArray(question.options)) {
            console.error('Invalid question data:', question);
            showError('Invalid question data. Please try restarting the quiz.');
            return;
        }
        
        console.log(`Showing question ${currentQuestion + 1}:`, {
            word: question.word,
            correctAnswer: question.correctAnswer,
            correctAnswerType: typeof question.correctAnswer,
            options: question.options
        });
        
        questionContainer.innerHTML = `
            <div class="text-center mb-6">
                <div class="flex items-center justify-center mb-4">
                    <div class="text-4xl md:text-5xl font-bold text-text-light mr-4">${question.word}</div>
                    <button id="speech-button" class="speech-button p-3 rounded-full bg-card-bg text-text-light border border-text-muted/30 cursor-pointer hover:bg-card-bg/70 transition duration-300" title="Click to hear pronunciation" aria-label="Click to hear pronunciation">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
                <div class="text-xl text-secondary-cyan mb-2">${question.pinyin || ''}</div>
                <div class="text-lg text-text-muted">What does this word mean in English?</div>
            </div>
        `;
        
        // Add event listener to speech button
        const speechButton = document.getElementById('speech-button');
        speechButton.addEventListener('click', function() {
            userInteractedWithSpeech = true;
            speakText(question.word);
        });
        
        optionsContainer.innerHTML = '';
        question.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'option-button py-4 px-6 rounded-lg bg-card-bg text-text-light border border-text-muted/30 font-medium text-left';
            button.innerHTML = `
                <span class="font-bold mr-3">${String.fromCharCode(65 + index)}.</span> ${option}
            `;
            button.addEventListener('click', () => selectOption(index));
            optionsContainer.appendChild(button);
        });
        
        feedbackElement.classList.add('hidden');
        feedbackElement.textContent = '';
        
        prevButton.disabled = currentQuestion === 0;
        if (prevButton.disabled) {
            prevButton.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            prevButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        
        if (currentQuestion === quizData.length - 1) {
            nextButton.innerHTML = 'Finish <i class="fas fa-flag-checkered ml-2"></i>';
        } else {
            nextButton.innerHTML = 'Next <i class="fas fa-arrow-right ml-2"></i>';
        }
        
        if (userAnswers[currentQuestion] !== null) {
            highlightOption(userAnswers[currentQuestion], quizData[currentQuestion].correctAnswer);
        }
        
        // Auto-speak the new question
        setTimeout(() => {
            autoSpeakQuestion(question.word);
        }, 500);
    }

    // Enhanced selectOption function with adaptive learning
    function selectOption(selectedIndex) {
        if (userAnswers[currentQuestion] !== null) return;
        
        const question = quizData[currentQuestion];
        
        // Get the correct answer directly from backend data
        let correctAnswerIndex;
        
        if (typeof question.correctAnswer === 'string') {
            correctAnswerIndex = parseInt(question.correctAnswer);
        } else {
            correctAnswerIndex = question.correctAnswer;
        }
        
        // Validate the correct answer index
        if (isNaN(correctAnswerIndex) || correctAnswerIndex < 0 || correctAnswerIndex >= question.options.length) {
            console.error('Invalid correct answer index:', correctAnswerIndex);
            // Fallback to first option if invalid
            correctAnswerIndex = 0;
        }
        
        const isCorrect = selectedIndex === correctAnswerIndex;
        
        // Update adaptive learning system
        updateWordMastery(question, isCorrect);
        
        // DEBUGGING
        console.log('=== ANSWER DEBUG INFO ===');
        console.log('Question word:', question.word);
        console.log('Selected index:', selectedIndex);
        console.log('Selected option:', question.options[selectedIndex]);
        console.log('Correct index:', correctAnswerIndex);
        console.log('Correct option:', question.options[correctAnswerIndex]);
        console.log('Is correct:', isCorrect);
        
        userAnswers[currentQuestion] = selectedIndex;
        
        // Play sound effect based on answer
        if (isCorrect) {
            playCorrectSound();
            score += 10;
            correctAnswers++;
            feedbackElement.textContent = 'Correct! Well done.';
            feedbackElement.className = 'mb-6 text-center text-lg font-medium text-green-400';
        } else {
            playIncorrectSound();
            incorrectAnswers++;
            feedbackElement.textContent = `Incorrect. The correct answer is: "${question.options[correctAnswerIndex]}"`;
            feedbackElement.className = 'mb-6 text-center text-lg font-medium text-red-400';
        }
        
        feedbackElement.classList.remove('hidden');
        updateScore();
        highlightOption(selectedIndex, correctAnswerIndex);
    }

    // Highlight selected option and correct answer
    function highlightOption(selectedIndex, correctIndex) {
        const optionButtons = optionsContainer.querySelectorAll('.option-button');
        
        optionButtons.forEach((button, index) => {
            button.classList.remove('correct', 'incorrect');
            
            if (index === correctIndex) {
                button.classList.add('correct');
            } else if (index === selectedIndex && index !== correctIndex) {
                button.classList.add('incorrect');
            }
            
            button.disabled = true;
        });
    }

    // Next question
    function nextQuestion() {
        if (currentQuestion < quizData.length - 1) {
            currentQuestion++;
            showQuestion();
            updateProgress();
        } else {
            finishQuiz();
        }
    }

    // Previous question
    function prevQuestion() {
        if (currentQuestion > 0) {
            currentQuestion--;
            showQuestion();
            updateProgress();
        }
    }

    // Update progress bar
    function updateProgress() {
        const progress = ((currentQuestion + 1) / quizData.length) * 100;
        progressText.textContent = `${currentQuestion + 1}/${quizData.length}`;
        progressFill.style.width = `${progress}%`;
    }

    // Update score display
    function updateScore() {
        scoreElement.textContent = score;
        correctCountElement.textContent = correctAnswers;
        incorrectCountElement.textContent = incorrectAnswers;
    }

    // Save quiz results to localStorage for results page
    function saveQuizResultsToLocalStorage() {
        try {
            // 1. Save to quiz history
            const quizHistory = JSON.parse(localStorage.getItem('hsk1QuizHistory') || '[]');
            
            const quizResult = {
                quiz_type: 'words', // Crucial for results page
                correct_answers: correctAnswers,
                total_questions: quizData.length,
                percentage: Math.round((correctAnswers / quizData.length) * 100),
                timestamp: new Date().toISOString(),
                score: score
            };
            
            quizHistory.unshift(quizResult); // Add to beginning
            localStorage.setItem('hsk1QuizHistory', JSON.stringify(quizHistory));
            
            // 2. Save to performance data
            let performanceData = JSON.parse(localStorage.getItem('hsk1PerformanceData') || '{}');
            if (!performanceData.words) performanceData.words = {};
            
            // Track performance for each word in this quiz
            quizData.forEach((question, index) => {
                const word = question.word;
                
                // Get correct answer index properly
                let correctAnswerIndex;
                if (typeof question.correctAnswer === 'string') {
                    correctAnswerIndex = parseInt(question.correctAnswer);
                } else {
                    correctAnswerIndex = question.correctAnswer;
                }
                
                const isCorrect = userAnswers[index] === correctAnswerIndex;
                
                if (!performanceData.words[word]) {
                    performanceData.words[word] = {
                        pinyin: question.pinyin || '',
                        meaning: question.options[correctAnswerIndex] || '',
                        correct: 0,
                        incorrect: 0
                    };
                }
                
                if (isCorrect) {
                    performanceData.words[word].correct++;
                } else {
                    performanceData.words[word].incorrect++;
                }
            });
            
            localStorage.setItem('hsk1PerformanceData', JSON.stringify(performanceData));
            
            console.log('Words quiz results saved to localStorage!');
            
        } catch (error) {
            console.error('Error saving words quiz results:', error);
        }
    }

    // Enhanced finishQuiz function with adaptive learning summary
    function finishQuiz() {
        speechSynthesis.cancel();
        
        const percentage = Math.round((correctAnswers / quizData.length) * 100);
        const timeTaken = Math.round((new Date() - startTime) / 1000);
        
        // Calculate adaptive learning statistics
        const adaptiveStats = calculateAdaptiveLearningStats();
        
        // Play celebration sound for excellent scores
        if (percentage >= 90) {
            setTimeout(() => playLevelUpSound(), 500);
        }
        
        finalScoreElement.textContent = score;
        finalCorrectElement.textContent = correctAnswers;
        finalIncorrectElement.textContent = incorrectAnswers;
        finalPercentageElement.textContent = `${percentage}%`;
        
        let performanceMessage = '';
        if (percentage >= 90) {
            performanceMessage = 'Outstanding! You have mastered HSK1 vocabulary. You are ready for the next level!';
        } else if (percentage >= 70) {
            performanceMessage = 'Good job! You have a solid understanding of HSK1 vocabulary. Keep practicing to improve further.';
        } else if (percentage >= 50) {
            performanceMessage = 'Not bad! You know some HSK1 vocabulary, but there is room for improvement. Review the words you missed.';
        } else {
            performanceMessage = 'Keep practicing! HSK1 vocabulary takes time to master. Try reviewing the words and taking the quiz again.';
        }
        
        // Add adaptive learning insights
        performanceMessage += `\n\nAdaptive Learning Insights:\n`;
        performanceMessage += ` ${adaptiveStats.masteredThisSession} words mastered this session\n`;
        performanceMessage += ` ${adaptiveStats.weakWordsCount} words need more practice\n`;
        performanceMessage += ` ${adaptiveStats.reviewWordsCount} words in your review list`;
        
        performanceMessageElement.textContent = performanceMessage;
        
        quizContent.classList.add('hidden');
        resultsSection.classList.remove('hidden');
        
        // Save quiz results to localStorage for results page
        saveQuizResultsToLocalStorage();
        
        // Also save to sessionStorage for immediate results
        const quizResult = {
            quiz_type: 'words',
            correct_answers: correctAnswers,
            total_questions: quizData.length,
            percentage: percentage,
            timestamp: new Date().toISOString(),
            adaptive_stats: adaptiveStats
        };
        sessionStorage.setItem('quizResults', JSON.stringify(quizResult));
        
        console.log('Quiz completed with adaptive learning stats:', adaptiveStats);
    }

    // UI State Management
    function showError(message) {
        loadingState.classList.add('hidden');
        quizContent.classList.add('hidden');
        errorState.classList.remove('hidden');
        errorMessage.textContent = message;
    }
</script>
</body>
</html>