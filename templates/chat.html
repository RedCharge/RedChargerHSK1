<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Chat - RedCharger HSK1</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Georgia', 'serif'],
                    },
                    colors: {
                        'primary-blue': '#5c7cfa',
                        'secondary-cyan': '#33f0e8',
                        'main-bg': '#1e293b',
                        'card-bg': '#2a3a50',
                        'text-light': '#e2e8f0',
                        'text-muted': '#94a3b8',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        gradientShift: {
                            '0%': { backgroundPosition: '0% 50%' },
                            '100%': { backgroundPosition: '100% 50%' },
                        },
                        pulseGlow: {
                            '0%': { boxShadow: '0 0 5px rgba(51, 240, 232, 0.5)' },
                            '100%': { boxShadow: '0 0 20px rgba(51, 240, 232, 0.8), 0 0 30px rgba(51, 240, 232, 0.6)' },
                        }
                    },
                    animation: {
                        fadeInUp: 'fadeInUp 0.6s ease-out forwards',
                        gradientShift: 'gradientShift 3s ease infinite alternate',
                        pulseGlow: 'pulseGlow 2s ease-in-out infinite alternate',
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e293b;
            min-height: 100vh;
            color: #e2e8f0;
            overflow-x: hidden;
            position: relative;
        }

        .nav-card {
            background-color: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sophisticated-card {
            background-color: #2a3a50;
            border-radius: 0.75rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .sophisticated-card:hover {
             transform: translateY(-5px) scale(1.01);
             box-shadow: 0 12px 35px rgba(0, 0, 0, 0.6), 0 0 20px rgba(92, 124, 250, 0.3);
        }

        .cta-button-primary, .cta-button-secondary {
            border: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cta-button-primary {
            background: linear-gradient(135deg, #5c7cfa, #3d5ad8);
            color: white;
            box-shadow: 0 5px 20px rgba(92, 124, 250, 0.5);
            background-size: 200% auto;
            animation: gradientShift 3s ease infinite alternate;
        }
        
        .cta-button-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(92, 124, 250, 0.7);
        }

        .cta-button-secondary {
            background: linear-gradient(135deg, #33f0e8, #25c0b8);
            color: #1e293b;
            box-shadow: 0 5px 20px rgba(51, 240, 232, 0.4);
        }

        .cta-button-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(51, 240, 232, 0.6);
        }

        .profile-card {
            background: linear-gradient(135deg, #2a3a50, #1e293b);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .profile-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(51, 240, 232, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .profile-card:hover::before {
            left: 100%;
        }

        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5), 0 0 25px rgba(51, 240, 232, 0.3);
        }

        .form-input {
            background: rgba(42, 58, 80, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            color: #e2e8f0;
        }

        .form-input:focus {
            border-color: #33f0e8;
            box-shadow: 0 0 0 3px rgba(51, 240, 232, 0.1);
            outline: none;
        }

        .form-label {
            color: #94a3b8;
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }

        /* Mobile dropdown menu styles */
        .mobile-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: rgba(42, 58, 80, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 50;
            opacity: 0;
            transform: translateY(-10px);
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .mobile-dropdown-menu.open {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .mobile-dropdown-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 45;
            background-color: transparent;
            display: none;
        }

        /* Chat specific styles */
        .chat-container {
            height: calc(100vh - 180px);
            display: flex;
            flex-direction: column;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 80%;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            position: relative;
            animation: fadeInUp 0.3s ease-out;
        }

        .message-sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #5c7cfa, #3d5ad8);
            border-bottom-right-radius: 0.25rem;
        }

        .message-received {
            align-self: flex-start;
            background: #2a3a50;
            border-bottom-left-radius: 0.25rem;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 0.5rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .message-username {
            font-size: 0.75rem;
            font-weight: 600;
            color: #94a3b8;
        }

        .message-time {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 0.25rem;
            text-align: right;
        }

        .message-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: none;
            gap: 0.25rem;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action {
            background: rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .message-action:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .reply-indicator {
            background: rgba(42, 58, 80, 0.8);
            border-left: 3px solid #33f0e8;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .reply-username {
            font-weight: 600;
            color: #33f0e8;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            color: #94a3b8;
            font-style: italic;
            font-size: 0.85rem;
        }

        .typing-dots {
            display: flex;
            margin-left: 0.5rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #33f0e8;
            margin: 0 1px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingAnimation {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: #2a3a50;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 0.75rem 1rem;
            color: #e2e8f0;
            resize: none;
            max-height: 120px;
            min-height: 44px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #33f0e8;
            box-shadow: 0 0 0 2px rgba(51, 240, 232, 0.1);
        }

        .send-button {
            background: linear-gradient(135deg, #33f0e8, #25c0b8);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1e293b;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(51, 240, 232, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .reply-preview {
            background: rgba(42, 58, 80, 0.9);
            border-left: 3px solid #33f0e8;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reply-preview-text {
            font-size: 0.85rem;
            color: #94a3b8;
            max-width: 80%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cancel-reply {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1rem;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10b981;
            margin-left: 0.5rem;
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: #2a3a50;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .chat-info {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #94a3b8;
            text-align: center;
            padding: 2rem;
        }

        .empty-chat-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #5c7cfa;
        }

        .deleted-message {
            font-style: italic;
            color: #94a3b8;
            opacity: 0.7;
        }
    </style>
</head>
<body class="selection:bg-primary-blue selection:text-white">

    <!-- Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 z-50 p-4 lg:p-6 nav-card">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="text-2xl font-black tracking-widest bg-clip-text text-transparent bg-gradient-to-r from-text-light to-secondary-cyan">
                RedCharger
            </div>
            
            <!-- Desktop Menu -->
            <div class="space-x-8 hidden md:flex font-medium">
                <a href="/" class="text-text-muted hover:text-secondary-cyan transition duration-300">Home</a>
                <a href="/words/quiz" class="text-text-muted hover:text-secondary-cyan transition duration-300">Words Quiz</a>
                <a href="/sentences/quiz" class="text-text-muted hover:text-secondary-cyan transition duration-300">Sentences Quiz</a>
                <a href="/learn" class="text-text-muted hover:text-secondary-cyan transition duration-300">Learn</a>
                <a href="/profile" class="text-text-muted hover:text-secondary-cyan transition duration-300">Profile</a>
                <a href="/result" class="text-text-muted hover:text-secondary-cyan transition duration-300">Results</a>
                <a href="/chat" class="text-secondary-cyan transition duration-300">Community Chat</a>
            </div>

            <!-- Desktop View Results Button -->
            <a href="/result" class="hidden md:flex py-2 px-5 rounded-full cta-button-secondary font-extrabold text-base shadow-xl hover:shadow-2xl transition duration-300">
                View Results
            </a>

            <!-- Mobile Menu Container -->
            <div class="md:hidden flex items-center space-x-3">
                <!-- Mobile View Results Button -->
                <a href="/result" class="py-1 px-3 rounded-full text-sm cta-button-secondary font-bold shadow-xl transition duration-300">
                    Results
                </a>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-button" class="text-text-muted hover:text-secondary-cyan transition duration-300 relative z-50">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Dropdown Menu -->
        <div id="mobile-dropdown-menu" class="mobile-dropdown-menu md:hidden w-full left-0">
            <div class="p-4 space-y-3">
                <a href="/" class="flex items-center text-text-light hover:text-secondary-cyan transition duration-300 p-3 rounded-lg hover:bg-card-bg/50">
                    <i class="fas fa-home mr-3 w-5 text-center"></i>
                    <span>Home</span>
                </a>
                <a href="/words/quiz" class="flex items-center text-text-light hover:text-secondary-cyan transition duration-300 p-3 rounded-lg hover:bg-card-bg/50">
                    <i class="fas fa-book mr-3 w-5 text-center"></i>
                    <span>Words Quiz</span>
                </a>
                <a href="/sentences/quiz" class="flex items-center text-text-light hover:text-secondary-cyan transition duration-300 p-3 rounded-lg hover:bg-card-bg/50">
                    <i class="fas fa-comments mr-3 w-5 text-center"></i>
                    <span>Sentences Quiz</span>
                </a>
                <a href="/learn" class="flex items-center text-text-light hover:text-secondary-cyan transition duration-300 p-3 rounded-lg hover:bg-card-bg/50">
                    <i class="fas fa-graduation-cap mr-3 w-5 text-center"></i>
                    <span>Learn</span>
                </a>
                <a href="/profile" class="flex items-center text-text-light hover:text-secondary-cyan transition duration-300 p-3 rounded-lg hover:bg-card-bg/50">
                    <i class="fas fa-user mr-3 w-5 text-center"></i>
                    <span>Profile</span>
                </a>
                <a href="/result" class="flex items-center text-text-light hover:text-secondary-cyan transition duration-300 p-3 rounded-lg hover:bg-card-bg/50">
                    <i class="fas fa-chart-bar mr-3 w-5 text-center"></i>
                    <span>Results</span>
                </a>
                <a href="/chat" class="flex items-center text-secondary-cyan transition duration-300 p-3 rounded-lg hover:bg-card-bg/50">
                    <i class="fas fa-users mr-3 w-5 text-center"></i>
                    <span>Community Chat</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Mobile Dropdown Backdrop -->
    <div id="mobile-dropdown-backdrop" class="mobile-dropdown-backdrop md:hidden"></div>

    <main class="pt-24 pb-16">
        <!-- Header Section -->
        <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 mb-8">
            <div class="text-center">
                <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-text-light">
                    Community <span class="text-secondary-cyan">Chat</span>
                </h1>
                <p class="text-xl text-text-muted max-w-2xl mx-auto">
                    Connect with fellow learners, share tips, and practice together
                </p>
            </div>
        </section>

        <!-- Chat Container -->
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="profile-card chat-container">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div>
                        <div class="chat-title">RedCharger Community</div>
                        <div class="chat-info">
                            <span id="online-count">0</span> learners online
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary-blue to-secondary-cyan flex items-center justify-center text-white font-bold">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="messages-container" id="messages-container">
                    <!-- Messages will be loaded here -->
                    <div class="empty-chat" id="empty-chat">
                        <i class="fas fa-comments empty-chat-icon"></i>
                        <h3 class="text-xl font-semibold mb-2">Welcome to the Community Chat!</h3>
                        <p class="text-text-muted">Start a conversation with fellow Mandarin learners. Share tips, ask questions, and practice together.</p>
                    </div>
                </div>

                <!-- Reply Preview -->
                <div class="reply-preview hidden" id="reply-preview">
                    <div class="reply-preview-text">
                        Replying to: <span id="reply-username"></span> - <span id="reply-text"></span>
                    </div>
                    <button class="cancel-reply" id="cancel-reply">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator hidden" id="typing-indicator">
                    <span id="typing-users"></span> is typing
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="message-input" 
                            placeholder="Type your message here..." 
                            rows="1"
                        ></textarea>
                        <button class="send-button" id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="py-10 border-t border-main-bg/20 text-center text-text-muted bg-card-bg mt-8">
        <p class="text-sm">&copy; 2025 RedCharger. Designed for effective Mandarin learning.</p>
    </footer>

        <!-- Chat Logic -->
    <script>
        // DOM Elements
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileDropdownMenu = document.getElementById('mobile-dropdown-menu');
        const mobileDropdownBackdrop = document.getElementById('mobile-dropdown-backdrop');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const emptyChat = document.getElementById('empty-chat');
        const replyPreview = document.getElementById('reply-preview');
        const replyUsername = document.getElementById('reply-username');
        const replyText = document.getElementById('reply-text');
        const cancelReply = document.getElementById('cancel-reply');
        const typingIndicator = document.getElementById('typing-indicator');
        const typingUsers = document.getElementById('typing-users');
        const onlineCount = document.getElementById('online-count');

        // API Base URL
        const API_BASE = '/api/chat';

        // Chat state
        let currentUser = null;
        let replyingTo = null;
        let typingTimeout = null;
        let lastMessageId = null;
        let isTyping = false;
        let pollingActive = true;
        let onlineUsers = new Set();
        let typingUsersSet = new Set();

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMobileMenu();
            checkUserProfileAndInitialize();
        });

        // Initialize Mobile Menu
        function initializeMobileMenu() {
            let isMenuOpen = false;

            function toggleMobileMenu() {
                isMenuOpen = !isMenuOpen;
                
                if (isMenuOpen) {
                    mobileDropdownMenu.classList.add('open');
                    mobileDropdownBackdrop.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                    mobileMenuButton.innerHTML = '<i class="fas fa-times text-xl"></i>';
                    mobileMenuButton.classList.remove('text-text-muted');
                    mobileMenuButton.classList.add('text-secondary-cyan');
                } else {
                    mobileDropdownMenu.classList.remove('open');
                    mobileDropdownBackdrop.style.display = 'none';
                    document.body.style.overflow = '';
                    mobileMenuButton.innerHTML = '<i class="fas fa-bars text-xl"></i>';
                    mobileMenuButton.classList.remove('text-secondary-cyan');
                    mobileMenuButton.classList.add('text-text-muted');
                }
            }

            function closeMobileMenu() {
                isMenuOpen = false;
                mobileDropdownMenu.classList.remove('open');
                mobileDropdownBackdrop.style.display = 'none';
                document.body.style.overflow = '';
                mobileMenuButton.innerHTML = '<i class="fas fa-bars text-xl"></i>';
                mobileMenuButton.classList.remove('text-secondary-cyan');
                mobileMenuButton.classList.add('text-text-muted');
            }

            mobileMenuButton.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleMobileMenu();
            });

            mobileDropdownBackdrop.addEventListener('click', closeMobileMenu);

            const menuLinks = mobileDropdownMenu.querySelectorAll('a');
            menuLinks.forEach(link => {
                link.addEventListener('click', closeMobileMenu);
            });

            document.addEventListener('click', function(e) {
                if (isMenuOpen && 
                    !mobileDropdownMenu.contains(e.target) && 
                    !mobileMenuButton.contains(e.target)) {
                    closeMobileMenu();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (isMenuOpen && e.key === 'Escape') {
                    closeMobileMenu();
                }
            });

            window.addEventListener('resize', function() {
                if (window.innerWidth >= 768 && isMenuOpen) {
                    closeMobileMenu();
                }
            });
        }

        // Check if user has completed profile and initialize chat
        async function checkUserProfileAndInitialize() {
            const profile = getProfile();
            
            if (!profile.username) {
                // Show profile completion required message
                showProfileRequiredMessage();
                return;
            }
            
            currentUser = profile;
            
            // Initialize chat functionality
            initializeChat();
            
            // Mark user as online
            try {
                await updateOnlineStatus(true);
            } catch (error) {
                console.error('Failed to set online status:', error);
            }
            
            // Start polling
            startPolling();
        }

        // Show profile completion required message
        function showProfileRequiredMessage() {
            emptyChat.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-user-slash empty-chat-icon text-yellow-500"></i>
                    <h3 class="text-xl font-semibold mb-2">Profile Required</h3>
                    <p class="text-text-muted mb-4">Please complete your profile before using the chat.</p>
                    <button onclick="redirectToProfile()" class="cta-button-primary py-2 px-6 rounded-lg font-medium">
                        <i class="fas fa-user-edit mr-2"></i> Complete Profile
                    </button>
                </div>
            `;
            
            // Disable chat input
            messageInput.disabled = true;
            messageInput.placeholder = "Please complete your profile to chat";
            sendButton.disabled = true;
        }

        // Redirect to profile page
        function redirectToProfile() {
            window.location.href = '/profile';
        }

        // Get user profile from localStorage
        function getProfile() {
            const defaultProfile = {
                username: '',
                email: '',
                firstName: '',
                lastName: '',
                bio: '',
                avatar: '',
                dailyGoal: '20',
                learningMode: 'both',
                enableSpeech: true,
                showPinyin: true,
                memberSince: new Date().toISOString(),
                stats: {
                    totalWords: 0,
                    totalSentences: 0,
                    streakDays: 0,
                    accuracyRate: 0,
                    totalQuizzes: 0,
                    wordsMastered: 0,
                    sentencesMastered: 0
                }
            };
            
            const saved = localStorage.getItem('userProfile');
            return saved ? { ...defaultProfile, ...JSON.parse(saved) } : defaultProfile;
        }

        // Initialize chat functionality
        function initializeChat() {
            // Load existing messages
            loadMessages();
            
            // Set up event listeners
            messageInput.addEventListener('input', handleInput);
            messageInput.addEventListener('keydown', handleKeyDown);
            sendButton.addEventListener('click', sendMessage);
            cancelReply.addEventListener('click', cancelReplyTo);
            
            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // Update send button state
            messageInput.addEventListener('input', function() {
                sendButton.disabled = this.value.trim() === '';
            });
            
            // Initialize with disabled send button
            sendButton.disabled = true;

            // Set up page visibility change handlers
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('beforeunload', handleBeforeUnload);
        }

        // Handle input for typing indicators
        function handleInput() {
            if (!isTyping) {
                isTyping = true;
                updateTypingStatus(true);
            }
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                updateTypingStatus(false);
            }, 1000);
        }

        // Handle keydown events (Enter to send, Escape to cancel reply)
        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            } else if (e.key === 'Escape' && replyingTo) {
                cancelReplyTo();
            }
        }

        // Send a new message
        async function sendMessage() {
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentUser) return;
            
            // Disable send button temporarily
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch(`${API_BASE}/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: messageText,
                        reply_to: replyingTo ? replyingTo.id : null,
                        user_profile: currentUser
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    // Message sent successfully
                    if (result.message) {
                        addMessageToChat(result.message);
                        lastMessageId = result.message.id;
                    }
                    
                    // Clear input and reset state
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    sendButton.disabled = true;
                    
                    // Cancel any reply
                    if (replyingTo) {
                        cancelReplyTo();
                    }
                    
                    // Stop typing indicator
                    isTyping = false;
                    updateTypingStatus(false);
                    
                    // Scroll to bottom
                    scrollToBottom();
                } else {
                    throw new Error(result.error || 'Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showError('Network error. Please check your connection and try again.');
                
                // Re-enable send button
                sendButton.disabled = false;
            } finally {
                // Reset send button
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendButton.disabled = messageInput.value.trim() === '';
            }
        }

        // Add a message to the chat UI
        function addMessageToChat(message) {
            // Hide empty chat message if it's the first message
            if (emptyChat.style.display !== 'none') {
                emptyChat.style.display = 'none';
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.user_id === currentUser.username ? 'message-sent' : 'message-received'}`;
            messageElement.dataset.messageId = message.id;
            
            // Create message header with avatar and username
            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';
            
            const avatarElement = document.createElement('div');
            avatarElement.className = 'message-avatar';
            
            if (message.avatar) {
                avatarElement.innerHTML = `<img src="${message.avatar}" alt="${message.username}" class="w-full h-full object-cover">`;
            } else {
                const initials = message.username.charAt(0).toUpperCase();
                avatarElement.style.background = 'linear-gradient(135deg, #5c7cfa, #3d5ad8)';
                avatarElement.style.color = 'white';
                avatarElement.textContent = initials;
            }
            
            const usernameElement = document.createElement('span');
            usernameElement.className = 'message-username';
            usernameElement.textContent = message.username;
            
            messageHeader.appendChild(avatarElement);
            messageHeader.appendChild(usernameElement);
            
            // Create reply indicator if this is a reply
            let replyIndicator = '';
            if (message.reply_to) {
                replyIndicator = `
                    <div class="reply-indicator">
                        Replying to <span class="reply-username">${message.reply_to.username}</span>: ${message.reply_to.text}
                    </div>
                `;
            }
            
            // Create message text
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.innerHTML = message.is_deleted ? 
                '<span class="deleted-message">This message was deleted</span>' : 
                message.text;
            
            // Create message time
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = formatTime(message.timestamp);
            
            // Create message actions (only for user's own messages)
            let messageActions = '';
            if (message.user_id === currentUser.username && !message.is_deleted) {
                messageActions = `
                    <div class="message-actions">
                        <button class="message-action reply-action" title="Reply">
                            <i class="fas fa-reply"></i>
                        </button>
                        <button class="message-action delete-action" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }
            
            // Build message HTML
            messageElement.innerHTML = `
                ${messageHeader.outerHTML}
                ${replyIndicator}
                ${messageText.outerHTML}
                ${messageTime.outerHTML}
                ${messageActions}
            `;
            
            // Add event listeners for actions
            if (message.user_id === currentUser.username && !message.is_deleted) {
                const replyBtn = messageElement.querySelector('.reply-action');
                const deleteBtn = messageElement.querySelector('.delete-action');
                
                replyBtn.addEventListener('click', () => replyToMessage(message));
                deleteBtn.addEventListener('click', () => deleteMessage(message.id));
            }
            
            // Add to messages container
            messagesContainer.appendChild(messageElement);
        }

        // Reply to a specific message
        function replyToMessage(message) {
            replyingTo = {
                id: message.id,
                username: message.username,
                text: message.text.length > 50 ? message.text.substring(0, 50) + '...' : message.text
            };
            
            // Show reply preview
            replyUsername.textContent = replyingTo.username;
            replyText.textContent = replyingTo.text;
            replyPreview.classList.remove('hidden');
            
            // Focus on input
            messageInput.focus();
        }

        // Cancel reply
        function cancelReplyTo() {
            replyingTo = null;
            replyPreview.classList.add('hidden');
        }

        // Delete a message
        async function deleteMessage(messageId) {
            if (confirm('Are you sure you want to delete this message?')) {
                try {
                    const response = await fetch(`${API_BASE}/delete/${messageId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_profile: currentUser
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.success) {
                        // Update UI
                        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                        if (messageElement) {
                            const messageText = messageElement.querySelector('.message-text');
                            messageText.innerHTML = '<span class="deleted-message">This message was deleted</span>';
                            
                            // Remove actions
                            const messageActions = messageElement.querySelector('.message-actions');
                            if (messageActions) {
                                messageActions.remove();
                            }
                        }
                    } else {
                        throw new Error(result.error || 'Failed to delete message');
                    }
                } catch (error) {
                    console.error('Error deleting message:', error);
                    showError('Network error. Please check your connection.');
                }
            }
        }

        // Load messages from API
        async function loadMessages() {
            try {
                const response = await fetch(`${API_BASE}/messages?limit=100`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.messages && result.messages.length > 0) {
                    emptyChat.style.display = 'none';
                    
                    result.messages.forEach(message => {
                        addMessageToChat(message);
                    });
                    
                    // Set last message ID for polling
                    if (result.messages.length > 0) {
                        lastMessageId = result.messages[result.messages.length - 1].id;
                    }
                    
                    scrollToBottom();
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                showError('Failed to load messages. Please refresh the page.');
            }
        }

        // Format timestamp for display
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) {
                return 'Just now';
            } else if (diffMins < 60) {
                return `${diffMins} min ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hr ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // Scroll to bottom of messages
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Update typing status via API
        async function updateTypingStatus(typing) {
            try {
                const response = await fetch(`${API_BASE}/typing`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        is_typing: typing,
                        user_profile: currentUser
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error updating typing status:', error);
            }
        }

        // Update online status via API
        async function updateOnlineStatus(isOnline) {
            try {
                const response = await fetch(`${API_BASE}/online`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        is_online: isOnline,
                        user_profile: currentUser
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.online_users) {
                    onlineUsers = new Set(result.online_users);
                    updateOnlineCount();
                }
            } catch (error) {
                console.error('Error updating online status:', error);
            }
        }

        // Real-time polling for new messages
        async function pollForUpdates() {
            if (!pollingActive || !currentUser) return;
            
            try {
                const url = lastMessageId ? 
                    `${API_BASE}/poll?last_message_id=${lastMessageId}` : 
                    `${API_BASE}/poll`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Process new messages
                if (result.new_messages && result.new_messages.length > 0) {
                    result.new_messages.forEach(message => {
                        addMessageToChat(message);
                        lastMessageId = message.id;
                    });
                    
                    if (result.new_messages.length > 0) {
                        scrollToBottom();
                    }
                }
                
                // Update typing indicators
                if (result.typing_users) {
                    typingUsersSet = new Set(result.typing_users.filter(user => user !== currentUser.username));
                    updateTypingIndicator();
                }
                
                // Update online users
                if (result.online_users) {
                    onlineUsers = new Set(result.online_users);
                    updateOnlineCount();
                }
                
            } catch (error) {
                console.error('Error polling for updates:', error);
                // Don't show error for polling failures - they're expected
            } finally {
                // Continue polling after a short delay
                if (pollingActive && currentUser) {
                    setTimeout(pollForUpdates, 2000);
                }
            }
        }

        // Start polling for real-time updates
        function startPolling() {
            pollingActive = true;
            pollForUpdates();
        }

        // Stop polling (when user leaves page)
        function stopPolling() {
            pollingActive = false;
        }

        // Update typing indicator UI
        function updateTypingIndicator() {
            if (typingUsersSet.size > 0) {
                const users = Array.from(typingUsersSet);
                if (users.length === 1) {
                    typingUsers.textContent = users[0];
                } else if (users.length === 2) {
                    typingUsers.textContent = `${users[0]} and ${users[1]}`;
                } else {
                    typingUsers.textContent = `${users[0]} and ${users.length - 1} others`;
                }
                
                typingIndicator.classList.remove('hidden');
            } else {
                typingIndicator.classList.add('hidden');
            }
        }

        // Update online user count
        function updateOnlineCount() {
            onlineCount.textContent = onlineUsers.size;
        }

        // Show error message
        function showError(message) {
            // Create a temporary error message
            const errorElement = document.createElement('div');
            errorElement.className = 'bg-red-600 text-white p-3 rounded-lg mb-4 text-center';
            errorElement.textContent = message;
            
            messagesContainer.insertBefore(errorElement, messagesContainer.firstChild);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (errorElement.parentNode) {
                    errorElement.remove();
                }
            }, 5000);
        }

        // Handle page visibility changes
        function handleVisibilityChange() {
            if (document.hidden) {
                // Page is hidden, mark user as offline
                updateOnlineStatus(false);
            } else {
                // Page is visible, mark user as online
                updateOnlineStatus(true);
            }
        }

        // Handle page unload
        function handleBeforeUnload() {
            stopPolling();
            updateOnlineStatus(false);
            updateTypingStatus(false);
        }
    </script>
</body>
</html>